<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第 15 章 JUnit Internals | Clean Code 中文</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/cleancode-book/assets/css/0.styles.5c3c855c.css" as="style"><link rel="preload" href="/cleancode-book/assets/js/app.641b54bb.js" as="script"><link rel="preload" href="/cleancode-book/assets/js/2.1ffb1fd2.js" as="script"><link rel="preload" href="/cleancode-book/assets/js/15.80e3ee62.js" as="script"><link rel="prefetch" href="/cleancode-book/assets/js/10.4982004a.js"><link rel="prefetch" href="/cleancode-book/assets/js/11.63f4c22d.js"><link rel="prefetch" href="/cleancode-book/assets/js/12.974bc5fb.js"><link rel="prefetch" href="/cleancode-book/assets/js/13.4a13d97d.js"><link rel="prefetch" href="/cleancode-book/assets/js/14.9f1bfef6.js"><link rel="prefetch" href="/cleancode-book/assets/js/16.43b379cc.js"><link rel="prefetch" href="/cleancode-book/assets/js/17.e4e6dc39.js"><link rel="prefetch" href="/cleancode-book/assets/js/18.c08029f3.js"><link rel="prefetch" href="/cleancode-book/assets/js/19.30c2b569.js"><link rel="prefetch" href="/cleancode-book/assets/js/20.4c5ffff6.js"><link rel="prefetch" href="/cleancode-book/assets/js/21.701caff3.js"><link rel="prefetch" href="/cleancode-book/assets/js/22.afcb0fb6.js"><link rel="prefetch" href="/cleancode-book/assets/js/23.abfed31b.js"><link rel="prefetch" href="/cleancode-book/assets/js/24.44780fe3.js"><link rel="prefetch" href="/cleancode-book/assets/js/25.cd991f1d.js"><link rel="prefetch" href="/cleancode-book/assets/js/3.f45e953a.js"><link rel="prefetch" href="/cleancode-book/assets/js/4.a1a0064b.js"><link rel="prefetch" href="/cleancode-book/assets/js/5.9c16c2fb.js"><link rel="prefetch" href="/cleancode-book/assets/js/6.cc601574.js"><link rel="prefetch" href="/cleancode-book/assets/js/7.e542ad6f.js"><link rel="prefetch" href="/cleancode-book/assets/js/8.0561f1ef.js"><link rel="prefetch" href="/cleancode-book/assets/js/9.d771df37.js">
    <link rel="stylesheet" href="/cleancode-book/assets/css/0.styles.5c3c855c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/cleancode-book/" class="home-link router-link-active"><!----> <span class="site-name">Clean Code 中文</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iszhaoxg/cleancode-book" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iszhaoxg/cleancode-book" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/cleancode-book/" aria-current="page" class="sidebar-link">Clean Code 中文</a></li><li><a href="/cleancode-book/ch1.html" class="sidebar-link">第 1 章 Clean Code 整洁代码</a></li><li><a href="/cleancode-book/ch2.html" class="sidebar-link">第 2 章 Meaningful Names 有意义的命名</a></li><li><a href="/cleancode-book/ch3.html" class="sidebar-link">第 3 章 Functions 函数</a></li><li><a href="/cleancode-book/ch4.html" class="sidebar-link">第 4 章 Comments 注释</a></li><li><a href="/cleancode-book/ch5.html" class="sidebar-link">第 5 章 Formatting 格式</a></li><li><a href="/cleancode-book/ch6.html" class="sidebar-link">第 6 章 Objects and Data Structures 对象和数据结构</a></li><li><a href="/cleancode-book/ch7.html" class="sidebar-link">第 7 章 Error Handling 错误处理</a></li><li><a href="/cleancode-book/ch8.html" class="sidebar-link">第 8 章 Boundaries 边界</a></li><li><a href="/cleancode-book/ch9.html" class="sidebar-link">第 9 章 Unit Tests</a></li><li><a href="/cleancode-book/ch10.html" class="sidebar-link">第 10 章 Classes</a></li><li><a href="/cleancode-book/ch11.html" class="sidebar-link">第 11 章 Systems</a></li><li><a href="/cleancode-book/ch12.html" class="sidebar-link">第 12 章 Emergence</a></li><li><a href="/cleancode-book/ch13.html" class="sidebar-link">第 13 章 Concurrency</a></li><li><a href="/cleancode-book/ch14.html" class="sidebar-link">第 14 章 Successive Refinement</a></li><li><a href="/cleancode-book/ch15.html" aria-current="page" class="active sidebar-link">第 15 章 JUnit Internals</a></li><li><a href="/cleancode-book/ch16.html" class="sidebar-link">第 16 章 Refactoring SerialDate</a></li><li><a href="/cleancode-book/ch17.html" class="sidebar-link">第 17 章 Smells and Heuristics</a></li><li><a href="/cleancode-book/apA.html" class="sidebar-link">Appendix A</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第-15-章-junit-internals"><a href="#第-15-章-junit-internals" class="header-anchor">#</a> 第 15 章 JUnit Internals</h1> <p><img src="figures/ch15/15_1fig_martin.jpg" alt=""></p> <p>JUnit is one of the most famous of all Java frameworks. As frameworks go, it is simple in conception, precise in definition, and elegant in implementation. But what does the code look like? In this chapter we’ll critique an example drawn from the JUnit framework.</p> <p>THE JUNIT FRAMEWORK
JUnit has had many authors, but it began with Kent Beck and Eric Gamma together on a plane to Atlanta. Kent wanted to learn Java, and Eric wanted to learn about Kent’s Smalltalk testing framework. “What could be more natural to a couple of geeks in cramped quarters than to pull out our laptops and start coding?”1 After three hours of high-altitude work, they had written the basics of JUnit.</p> <ol><li>JUnit Pocket Guide, Kent Beck, O’Reilly, 2004, p. 43.</li></ol> <p>The module we’ll look at is the clever bit of code that helps identify string comparison errors. This module is called ComparisonCompactor. Given two strings that differ, such as ABCDE and ABXDE, it will expose the difference by generating a string such as &lt;…B[X]D…&gt;.</p> <p>I could explain it further, but the test cases do a better job. So take a look at Listing 15-1 and you will understand the requirements of this module in depth. While you are at it, critique the structure of the tests. Could they be simpler or more obvious?</p> <p>Listing 15-1 ComparisonCompactorTest.java</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">package</span> <span class="token namespace">junit<span class="token punctuation">.</span>tests<span class="token punctuation">.</span>framework</span><span class="token punctuation">;</span>
   <span class="token keyword">import</span> <span class="token namespace">junit<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">ComparisonCompactor</span><span class="token punctuation">;</span>
   <span class="token keyword">import</span> <span class="token namespace">junit<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">TestCase</span><span class="token punctuation">;</span>
 
   <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComparisonCompactorTest</span> <span class="token keyword">extends</span> <span class="token class-name">TestCase</span> <span class="token punctuation">{</span>
 
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> “b”<span class="token punctuation">,</span> “c”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span>“a”<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertTrue</span><span class="token punctuation">(</span>“a expected<span class="token operator">:</span><span class="token operator">&lt;</span><span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token operator">&gt;</span>”<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>failure<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testStartSame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> “ba”<span class="token punctuation">,</span> “bc”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token operator">&lt;</span>b<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span>b<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token operator">&gt;</span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testEndSame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> “ab”<span class="token punctuation">,</span> “cb”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token operator">&lt;</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span>b<span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span>b<span class="token operator">&gt;</span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> “ab”<span class="token punctuation">,</span> “ab”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token generics"><span class="token punctuation">&lt;</span>ab<span class="token punctuation">&gt;</span></span> but was<span class="token operator">:</span><span class="token generics"><span class="token punctuation">&lt;</span>ab<span class="token punctuation">&gt;</span></span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testNoContextStartAndEndSame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> “abc”<span class="token punctuation">,</span> “adc”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token operator">&lt;</span>…<span class="token punctuation">[</span>b<span class="token punctuation">]</span>…<span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span>…<span class="token punctuation">[</span>d<span class="token punctuation">]</span>…<span class="token operator">&gt;</span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testStartAndEndContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> “abc”<span class="token punctuation">,</span> “adc”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token operator">&lt;</span>a<span class="token punctuation">[</span>b<span class="token punctuation">]</span>c<span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span>a<span class="token punctuation">[</span>d<span class="token punctuation">]</span>c<span class="token operator">&gt;</span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
  
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testStartAndEndContextWithEllipses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> 
    <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> “abcde”<span class="token punctuation">,</span> “abfde”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token operator">&lt;</span>…b<span class="token punctuation">[</span>c<span class="token punctuation">]</span>d…<span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span>…b<span class="token punctuation">[</span>f<span class="token punctuation">]</span>d…<span class="token operator">&gt;</span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testComparisonErrorStartSameComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> “ab”<span class="token punctuation">,</span> “abc”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token operator">&lt;</span>ab<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span>ab<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token operator">&gt;</span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testComparisonErrorEndSameComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> “bc”<span class="token punctuation">,</span> “abc”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>…<span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span>…<span class="token operator">&gt;</span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testComparisonErrorEndSameCompleteContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> “bc”<span class="token punctuation">,</span> “abc”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>bc<span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span>bc<span class="token operator">&gt;</span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testComparisonErrorOverlapingMatches</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> “abc”<span class="token punctuation">,</span> “abbc”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token operator">&lt;</span>…<span class="token punctuation">[</span><span class="token punctuation">]</span>…<span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span>…<span class="token punctuation">[</span>b<span class="token punctuation">]</span>…<span class="token operator">&gt;</span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testComparisonErrorOverlapingMatchesContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> “abc”<span class="token punctuation">,</span> “abbc”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token operator">&lt;</span>ab<span class="token punctuation">[</span><span class="token punctuation">]</span>c<span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span>ab<span class="token punctuation">[</span>b<span class="token punctuation">]</span>c<span class="token operator">&gt;</span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testComparisonErrorOverlapingMatches2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> “abcdde”<span class="token punctuation">,</span>
“abcde”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token operator">&lt;</span>…<span class="token punctuation">[</span>d<span class="token punctuation">]</span>…<span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span>…<span class="token punctuation">[</span><span class="token punctuation">]</span>…<span class="token operator">&gt;</span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testComparisonErrorOverlapingMatches2Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> 
      <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> “abcdde”<span class="token punctuation">,</span> “abcde”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token operator">&lt;</span>…cd<span class="token punctuation">[</span>d<span class="token punctuation">]</span>e<span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span>…cd<span class="token punctuation">[</span><span class="token punctuation">]</span>e<span class="token operator">&gt;</span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testComparisonErrorWithActualNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> “a”<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token generics"><span class="token punctuation">&lt;</span>a<span class="token punctuation">&gt;</span></span> but was<span class="token operator">:</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">null</span><span class="token punctuation">&gt;</span></span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
  
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testComparisonErrorWithActualNullContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> “a”<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token generics"><span class="token punctuation">&lt;</span>a<span class="token punctuation">&gt;</span></span> but was<span class="token operator">:</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">null</span><span class="token punctuation">&gt;</span></span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testComparisonErrorWithExpectedNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> “a”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">null</span><span class="token punctuation">&gt;</span></span> but was<span class="token operator">:</span><span class="token generics"><span class="token punctuation">&lt;</span>a<span class="token punctuation">&gt;</span></span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testComparisonErrorWithExpectedNullContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> “a”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">null</span><span class="token punctuation">&gt;</span></span> but was<span class="token operator">:</span><span class="token generics"><span class="token punctuation">&lt;</span>a<span class="token punctuation">&gt;</span></span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBug609972</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> failure<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> “<span class="token class-name">S</span><span class="token operator">&amp;</span>P500”<span class="token punctuation">,</span> “<span class="token number">0</span>”<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assertEquals</span><span class="token punctuation">(</span>“expected<span class="token operator">:</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token class-name">S</span><span class="token operator">&amp;</span>P50<span class="token punctuation">]</span><span class="token number">0</span><span class="token operator">&gt;</span> but was<span class="token operator">:</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token number">0</span><span class="token operator">&gt;</span>”<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
</code></pre></div><p>I ran a code coverage analysis on the ComparisonCompactor using these tests. The code is 100 percent covered. Every line of code, every if statement and for loop, is executed by the tests. This gives me a high degree of confidence that the code works and a high degree of respect for the craftsmanship of the authors.</p> <p>The code for ComparisonCompactor is in Listing 15-2. Take a moment to look over this code. I think you’ll find it to be nicely partitioned, reasonably expressive, and simple in structure. Once you are done, then we’ll pick the nits together.</p> <p>Listing 15-2 ComparisonCompactor.java (Original)</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">package</span> <span class="token namespace">junit<span class="token punctuation">.</span>framework</span><span class="token punctuation">;</span>
 
   <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComparisonCompactor</span> <span class="token punctuation">{</span>
 
     <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ELLIPSIS <span class="token operator">=</span> “…”<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DELTA_END <span class="token operator">=</span> “<span class="token punctuation">]</span>”<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DELTA_START <span class="token operator">=</span> “<span class="token punctuation">[</span>”<span class="token punctuation">;</span>
 
     <span class="token keyword">private</span> <span class="token keyword">int</span> fContextLength<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token class-name">String</span> fExpected<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token class-name">String</span> fActual<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token keyword">int</span> fPrefix<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token keyword">int</span> fSuffix<span class="token punctuation">;</span>
 
     <span class="token keyword">public</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token keyword">int</span> contextLength<span class="token punctuation">,</span>
                                <span class="token class-name">String</span> expected<span class="token punctuation">,</span>
                                  <span class="token class-name">String</span> actual<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       fContextLength <span class="token operator">=</span> contextLength<span class="token punctuation">;</span>
       fExpected <span class="token operator">=</span> expected<span class="token punctuation">;</span>
       fActual <span class="token operator">=</span> actual<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">compact</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>fExpected <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> fActual <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">areStringsEqual</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token keyword">return</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> fExpected<span class="token punctuation">,</span> fActual<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">findCommonSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> expected <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>fExpected<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> actual <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>fActual<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">compactString</span><span class="token punctuation">(</span><span class="token class-name">String</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> result <span class="token operator">=</span> DELTA_START <span class="token operator">+</span> 
                         source<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>fPrefix<span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> fSuffix <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> DELTA_END<span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>fPrefix <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
         result <span class="token operator">=</span> <span class="token function">computeCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> result<span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>fSuffix <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
         result <span class="token operator">=</span> result <span class="token operator">+</span> <span class="token function">computeCommonSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> result<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     fPrefix <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> end <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>fExpected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fActual<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> fPrefix <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> fPrefix<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>fExpected<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>fPrefix<span class="token punctuation">)</span> <span class="token operator">!=</span> fActual<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>fPrefix<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
 
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">findCommonSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">int</span> expectedSuffix <span class="token operator">=</span> fExpected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> actualSuffix <span class="token operator">=</span> fActual<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span>
          actualSuffix <span class="token operator">&gt;=</span> fPrefix <span class="token operator">&amp;&amp;</span> expectedSuffix <span class="token operator">&gt;=</span> fPrefix<span class="token punctuation">;</span>
           actualSuffix<span class="token operator">--</span><span class="token punctuation">,</span> expectedSuffix<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>fExpected<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>expectedSuffix<span class="token punctuation">)</span> <span class="token operator">!=</span> fActual<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>actualSuffix<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     fSuffix <span class="token operator">=</span> fExpected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> expectedSuffix<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 
   <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">computeCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token punctuation">(</span>fPrefix <span class="token operator">&gt;</span> fContextLength <span class="token operator">?</span> ELLIPSIS <span class="token operator">:</span> “”<span class="token punctuation">)</span> <span class="token operator">+</span>
              fExpected<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> fPrefix <span class="token operator">-</span> fContextLength<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     fPrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">computeCommonSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">int</span> end <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>fExpected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> fSuffix <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> fContextLength<span class="token punctuation">,</span>
                          fExpected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> fExpected<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>fExpected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> fSuffix <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span>fExpected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> fSuffix <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> fExpected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span>  fContextLength <span class="token operator">?</span> ELLIPSIS <span class="token operator">:</span> “”<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
   <span class="token punctuation">}</span>
 
   <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">areStringsEqual</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> fExpected<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>fActual<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>You might have a few complaints about this module. There are some long expressions and some strange +1s and so forth. But overall this module is pretty good. After all, it might have looked like Listing 15-3.</p> <p>Listing 15-3 ComparisonCompator.java (defactored)</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">package</span> <span class="token namespace">junit<span class="token punctuation">.</span>framework</span><span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token keyword">class</span>  <span class="token class-name">ComparisonCompactor</span> <span class="token punctuation">{</span>
     <span class="token keyword">private</span> <span class="token keyword">int</span> ctxt<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token class-name">String</span> s1<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token class-name">String</span> s2<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token keyword">int</span> pfx<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token keyword">int</span> sfx<span class="token punctuation">;</span>
     <span class="token keyword">public</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span><span class="token keyword">int</span> ctxt<span class="token punctuation">,</span> <span class="token class-name">String</span> s1<span class="token punctuation">,</span> <span class="token class-name">String</span> s2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>ctxt <span class="token operator">=</span> ctxt<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>s1 <span class="token operator">=</span> s1<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>s2 <span class="token operator">=</span> s2<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">compact</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>s1 <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s2 <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token keyword">return</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
       pfx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> pfx <span class="token operator">&lt;</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s2<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> pfx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>pfx<span class="token punctuation">)</span> <span class="token operator">!=</span> s2<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>pfx<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">int</span> sfx1 <span class="token operator">=</span> s1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
       <span class="token keyword">int</span> sfx2 <span class="token operator">=</span> s2<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> sfx2 <span class="token operator">&gt;=</span> pfx <span class="token operator">&amp;&amp;</span> sfx1 <span class="token operator">&gt;=</span> pfx<span class="token punctuation">;</span> sfx2<span class="token operator">--</span><span class="token punctuation">,</span> sfx1<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>sfx1<span class="token punctuation">)</span> <span class="token operator">!=</span> s2<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>sfx2<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
       sfx <span class="token operator">=</span> s1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> sfx1<span class="token punctuation">;</span>
       <span class="token class-name">String</span> cmp1 <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> cmp2 <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> cmp1<span class="token punctuation">,</span> cmp2<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">compactString</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token class-name">String</span> result <span class="token operator">=</span>
      “<span class="token punctuation">[</span>“ <span class="token operator">+</span> s<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>pfx<span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> sfx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> “<span class="token punctuation">]</span>”<span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>pfx <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
       result <span class="token operator">=</span> <span class="token punctuation">(</span>pfx <span class="token operator">&gt;</span> ctxt <span class="token operator">?</span> “…” <span class="token operator">:</span> “”<span class="token punctuation">)</span> <span class="token operator">+</span>
         s1<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pfx <span class="token operator">-</span> ctxt<span class="token punctuation">)</span><span class="token punctuation">,</span> pfx<span class="token punctuation">)</span> <span class="token operator">+</span> result<span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>sfx <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">int</span> end <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> sfx <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> ctxt<span class="token punctuation">,</span> s1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       result <span class="token operator">=</span> result <span class="token operator">+</span> <span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> sfx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span> <span class="token operator">+</span>
         <span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> sfx <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> s1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ctxt <span class="token operator">?</span> “…” <span class="token operator">:</span> “”<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>Even though the authors left this module in very good shape, the Boy Scout Rule2 tells us we should leave it cleaner than we found it. So, how can we improve on the original code in Listing 15-2?</p> <ol start="2"><li>See “The Boy Scout Rule” on page 14.</li></ol> <p>The first thing I don’t care for is the f prefix for the member variables [N6]. Today’s environments make this kind of scope encoding redundant. So let’s eliminate all the f’s.</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">private</span> <span class="token keyword">int</span> contextLength<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> expected<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> actual<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">int</span> prefix<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">int</span> suffix<span class="token punctuation">;</span>
</code></pre></div><p>Next, we have an unencapsulated conditional at the beginning of the compact function [G28].</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">compact</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>expected <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> actual <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">areStringsEqual</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token keyword">return</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">findCommonSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name">String</span> expected <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expected<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name">String</span> actual <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre></div><p>This conditional should be encapsulated to make our intent clear. So let’s extract a method that explains it.</p> <div class="language-java extra-class"><pre class="language-java"><code>     <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">compact</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldNotCompact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token keyword">return</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">findCommonSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> expected <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expected<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> actual <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">shouldNotCompact</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> expected <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> actual <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">areStringsEqual</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
</code></pre></div><p>I don’t much care for the this.expected and this.actual notation in the compact function. This happened when we changed the name of fExpected to expected. Why are there variables in this function that have the same names as the member variables? Don’t they represent something else [N4]? We should make the names unambiguous.</p> <p>String compactExpected = compactString(expected);   String compactActual = compactString(actual);</p> <p>Negatives are slightly harder to understand than positives [G29]. So let’s turn that if statement on its head and invert the sense of the conditional.</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">compact</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canBeCompacted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">findCommonSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> compactExpected <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>expected<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> compactActual <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> compactExpected<span class="token punctuation">,</span> compactActual<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">canBeCompacted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> expected <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> actual <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token function">areStringsEqual</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre></div><p>The name of the function is strange [N7]. Although it does compact the strings, it actually might not compact the strings if canBeCompacted returns false. So naming this function compact hides the side effect of the error check. Notice also that the function returns a formatted message, not just the compacted strings. So the name of the function should really be formatCompactedComparison. That makes it read a lot better when taken with the function argument:</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">formatCompactedComparison</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token class-name">The</span> body of the <span class="token keyword">if</span> statement is where the <span class="token boolean">true</span> compacting of the expected and actual strings is <span class="token class-name"><span class="token namespace">done<span class="token punctuation">.</span></span> We</span> should extract that as a method named <span class="token class-name"><span class="token namespace">compactExpectedAndActual<span class="token punctuation">.</span></span> However</span><span class="token punctuation">,</span> we want the formatCompactedComparison function <span class="token keyword">to</span> <span class="token keyword">do</span> all the <span class="token class-name"><span class="token namespace">formatting<span class="token punctuation">.</span></span> The</span> compact… function should <span class="token keyword">do</span> nothing but compacting <span class="token punctuation">[</span>G30<span class="token punctuation">]</span><span class="token punctuation">.</span> <span class="token class-name">So</span> let’s split it up as follows<span class="token operator">:</span>
```java
  …
    <span class="token keyword">private</span> <span class="token class-name">String</span> compactExpected<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> compactActual<span class="token punctuation">;</span> 
  …
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">formatCompactedComparison</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canBeCompacted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">compactExpectedAndActual</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> compactExpected<span class="token punctuation">,</span> compactActual<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 

        <span class="token keyword">return</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">compactExpectedAndActual</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">findCommonSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      compactExpected <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>expected<span class="token punctuation">)</span><span class="token punctuation">;</span>
      compactActual <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Notice that this required us to promote compactExpected and compactActual to member variables. I don’t like the way that the last two lines of the new function return variables, but the first two don’t. They aren’t using consistent conventions [G11]. So we should change findCommonPrefix and findCommonSuffix to return the prefix and suffix values.</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">compactExpectedAndActual</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    prefixIndex <span class="token operator">=</span> <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    suffixIndex <span class="token operator">=</span> <span class="token function">findCommonSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    compactExpected <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>expected<span class="token punctuation">)</span><span class="token punctuation">;</span>
    compactActual <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> prefixIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> end <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> actual<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> prefixIndex <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> prefixIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>prefixIndex<span class="token punctuation">)</span> <span class="token operator">!=</span> actual<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>prefixIndex<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> prefixIndex<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">findCommonSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">int</span> expectedSuffix <span class="token operator">=</span> expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> actualSuffix <span class="token operator">=</span> actual<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> actualSuffix <span class="token operator">&gt;=</span> prefixIndex <span class="token operator">&amp;&amp;</span> expectedSuffix <span class="token operator">&gt;=</span> prefixIndex<span class="token punctuation">;</span>
         actualSuffix<span class="token operator">--</span><span class="token punctuation">,</span> expectedSuffix<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>expectedSuffix<span class="token punctuation">)</span> <span class="token operator">!=</span> actual<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>actualSuffix<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> expectedSuffix<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>We should also change the names of the member variables to be a little more accurate [N1]; after all, they are both indices.</p> <p>Careful inspection of findCommonSuffix exposes a hidden temporal coupling [G31]; it depends on the fact that prefixIndex is calculated by findCommonPrefix. If these two functions were called out of order, there would be a difficult debugging session ahead. So, to expose this temporal coupling, let’s have findCommonSuffix take the prefixIndex as an argument.</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">compactExpectedAndActual</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     prefixIndex <span class="token operator">=</span> <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     suffixIndex <span class="token operator">=</span> <span class="token function">findCommonSuffix</span><span class="token punctuation">(</span>prefixIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
     compactExpected <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>expected<span class="token punctuation">)</span><span class="token punctuation">;</span>
     compactActual <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">findCommonSuffix</span><span class="token punctuation">(</span><span class="token keyword">int</span> prefixIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">int</span> expectedSuffix <span class="token operator">=</span> expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> actualSuffix <span class="token operator">=</span> actual<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> actualSuffix <span class="token operator">&gt;=</span> prefixIndex <span class="token operator">&amp;&amp;</span> expectedSuffix <span class="token operator">&gt;=</span> prefixIndex<span class="token punctuation">;</span>
          actualSuffix<span class="token operator">--</span><span class="token punctuation">,</span> expectedSuffix<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>expectedSuffix<span class="token punctuation">)</span> <span class="token operator">!=</span> actual<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>actualSuffix<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">return</span> expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> expectedSuffix<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre></div><p>I’m not really happy with this. The passing of the prefixIndex argument is a bit arbitrary [G32]. It works to establish the ordering but does nothing to explain the need for that ordering. Another programmer might undo what we have done because there’s no indication that the parameter is really needed. So let’s take a different tack.</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">compactExpectedAndActual</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">findCommonPrefixAndSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     compactExpected <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>expected<span class="token punctuation">)</span><span class="token punctuation">;</span>
     compactActual <span class="token operator">=</span> <span class="token function">compactString</span><span class="token punctuation">(</span>actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">findCommonPrefixAndSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> expectedSuffix <span class="token operator">=</span> expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> actualSuffix <span class="token operator">=</span> actual<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span>
          actualSuffix <span class="token operator">&gt;=</span> prefixIndex <span class="token operator">&amp;&amp;</span> expectedSuffix <span class="token operator">&gt;=</span> prefixIndex<span class="token punctuation">;</span>
          actualSuffix<span class="token operator">--</span><span class="token punctuation">,</span> expectedSuffix<span class="token operator">--</span> 
       <span class="token punctuation">)</span>  <span class="token punctuation">{</span>
 
       <span class="token keyword">if</span> <span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>expectedSuffix<span class="token punctuation">)</span> <span class="token operator">!=</span> actual<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>actualSuffix<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     suffixIndex <span class="token operator">=</span> expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> expectedSuffix<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     prefixIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> end <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> actual<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span>   prefixIndex <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> prefixIndex<span class="token operator">++</span><span class="token punctuation">)</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>prefixIndex<span class="token punctuation">)</span> <span class="token operator">!=</span> actual<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>prefixIndex<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre></div><p>We put findCommonPrefix and findCommonSuffix back the way they were, changing the name of findCommonSuffix to findCommonPrefixAnd Suffix and having it call findCommon-Prefix before doing anything else. That establishes the temporal nature of the two functions in a much more dramatic way than the previous solution. It also points out how ugly findCommonPrefixAndSuffix is. Let’s clean it up now.</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">findCommonPrefixAndSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> suffixLength <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token operator">!</span><span class="token function">suffixOverlapsPrefix</span><span class="token punctuation">(</span>suffixLength<span class="token punctuation">)</span><span class="token punctuation">;</span> suffixLength<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">charFromEnd</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> suffixLength<span class="token punctuation">)</span> <span class="token operator">!=</span>
            <span class="token function">charFromEnd</span><span class="token punctuation">(</span>actual<span class="token punctuation">,</span> suffixLength<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     suffixIndex <span class="token operator">=</span> suffixLength<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">char</span> <span class="token function">charFromEnd</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">suffixOverlapsPrefix</span><span class="token punctuation">(</span><span class="token keyword">int</span> suffixLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> actual<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> suffixLength <span class="token operator">&lt;</span> prefixLength <span class="token operator">||</span>
       expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> suffixLength <span class="token operator">&lt;</span> prefixLength<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre></div><p>This is much better. It exposes that the suffixIndex is really the length of the suffix and is not well named. The same is true of the prefixIndex, though in that case “index” and “length” are synonymous. Even so, it is more consistent to use “length.” The problem is that the suffixIndex variable is not zero based; it is 1 based and so is not a true length. This is also the reason that there are all those +1s in computeCommonSuffix [G33]. So let’s fix that. The result is in Listing 15-4.</p> <p>Listing 15-4 ComparisonCompactor.java (interim)</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComparisonCompactor</span> <span class="token punctuation">{</span>
   …
     <span class="token keyword">private</span> <span class="token keyword">int</span> suffixLength<span class="token punctuation">;</span>
   …
     <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">findCommonPrefixAndSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       suffixLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token operator">!</span><span class="token function">suffixOverlapsPrefix</span><span class="token punctuation">(</span>suffixLength<span class="token punctuation">)</span><span class="token punctuation">;</span> suffixLength<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">charFromEnd</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> suffixLength<span class="token punctuation">)</span> <span class="token operator">!=</span>
             <span class="token function">charFromEnd</span><span class="token punctuation">(</span>actual<span class="token punctuation">,</span> suffixLength<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">char</span> <span class="token function">charFromEnd</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">suffixOverlapsPrefix</span><span class="token punctuation">(</span><span class="token keyword">int</span> suffixLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> actual<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> suffixLength <span class="token operator">&lt;=</span> prefixLength <span class="token operator">||</span>
        expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> suffixLength <span class="token operator">&lt;=</span> prefixLength<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 …
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">compactString</span><span class="token punctuation">(</span><span class="token class-name">String</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> result <span class="token operator">=</span>
        DELTA_START <span class="token operator">+</span>
        source<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>prefixLength<span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> suffixLength<span class="token punctuation">)</span> <span class="token operator">+</span>
        DELTA_END<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prefixLength <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> <span class="token function">computeCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> result<span class="token punctuation">;</span> 
      <span class="token keyword">if</span> <span class="token punctuation">(</span>suffixLength <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> result <span class="token operator">+</span> <span class="token function">computeCommonSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  …
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">computeCommonSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> end <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> suffixLength <span class="token operator">+</span>
        contextLength<span class="token punctuation">,</span> expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span>
        expected<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> suffixLength<span class="token punctuation">,</span> end<span class="token punctuation">)</span> <span class="token operator">+</span>
        <span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> suffixLength <span class="token operator">&lt;</span>
          expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> contextLength <span class="token operator">?</span>
          ELLIPSIS <span class="token operator">:</span> “”<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>We replaced the +1s in computeCommonSuffix with a -1 in charFromEnd, where it makes perfect sense, and two &lt;= operators in suffixOverlapsPrefix, where they also make perfect sense. This allowed us to change the name of suffixIndex to suffixLength, greatly enhancing the readability of the code.</p> <p>There is a problem however. As I was eliminating the +1s, I noticed the following line in compactString:</p> <p>if (suffixLength &gt; 0)</p> <p>Take a look at it in Listing 15-4. By rights, because suffixLength is now one less than it used to be, I should change the &gt; operator to a &gt;= operator. But that makes no sense. It makes sense now! This means that it didn’t use to make sense and was probably a bug. Well, not quite a bug. Upon further analysis we see that the if statement now prevents a zero length suffix from being appended. Before we made the change, the if statement was nonfunctional because suffixIndex could never be less than one!</p> <p>This calls into question both if statements in compactString! It looks as though they could both be eliminated. So let’s comment them out and run the tests. They passed! So let’s restructure compactString to eliminate the extraneous if statements and make the function much simpler [G9].</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">compactString</span><span class="token punctuation">(</span><span class="token class-name">String</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span>
         <span class="token function">computeCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
         DELTA_START <span class="token operator">+</span>
         source<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>prefixLength<span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> suffixLength<span class="token punctuation">)</span> <span class="token operator">+</span>
         DELTA_END <span class="token operator">+</span>
         <span class="token function">computeCommonSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre></div><p>This is much better! Now we see that the compactString function is simply composing the fragments together. We can probably make this even clearer. Indeed, there are lots of little cleanups we could do. But rather than drag you through the rest of the changes, I’ll just show you the result in Listing 15-5.</p> <p>Listing 15-5 ComparisonCompactor.java (final)</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">package</span> <span class="token namespace">junit<span class="token punctuation">.</span>framework</span><span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComparisonCompactor</span> <span class="token punctuation">{</span>
 
     <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ELLIPSIS <span class="token operator">=</span> “…”<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DELTA_END <span class="token operator">=</span> “<span class="token punctuation">]</span>”<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DELTA_START <span class="token operator">=</span> “<span class="token punctuation">[</span>”<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token keyword">int</span> contextLength<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token class-name">String</span> expected<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token class-name">String</span> actual<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token keyword">int</span> prefixLength<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token keyword">int</span> suffixLength<span class="token punctuation">;</span>
 
     <span class="token keyword">public</span> <span class="token class-name">ComparisonCompactor</span><span class="token punctuation">(</span>
       <span class="token keyword">int</span> contextLength<span class="token punctuation">,</span> <span class="token class-name">String</span> expected<span class="token punctuation">,</span> <span class="token class-name">String</span> actual
     <span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>contextLength <span class="token operator">=</span> contextLength<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>expected <span class="token operator">=</span> expected<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>actual <span class="token operator">=</span> actual<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">formatCompactedComparison</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> compactExpected <span class="token operator">=</span> expected<span class="token punctuation">;</span>
       <span class="token class-name">String</span> compactActual <span class="token operator">=</span> actual<span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldBeCompacted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">findCommonPrefixAndSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         compactExpected <span class="token operator">=</span> <span class="token function">compact</span><span class="token punctuation">(</span>expected<span class="token punctuation">)</span><span class="token punctuation">;</span>
         compactActual <span class="token operator">=</span> <span class="token function">compact</span><span class="token punctuation">(</span>actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> 
      <span class="token keyword">return</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> compactExpected<span class="token punctuation">,</span> compactActual<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">shouldBeCompacted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">shouldNotBeCompacted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
   <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">shouldNotBeCompacted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> expected <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
            actual <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
            expected<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">findCommonPrefixAndSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     suffixLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token operator">!</span><span class="token function">suffixOverlapsPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> suffixLength<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">charFromEnd</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> suffixLength<span class="token punctuation">)</span> <span class="token operator">!=</span>
           <span class="token function">charFromEnd</span><span class="token punctuation">(</span>actual<span class="token punctuation">,</span> suffixLength<span class="token punctuation">)</span>
       <span class="token punctuation">)</span>
 
         <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">char</span> <span class="token function">charFromEnd</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">suffixOverlapsPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> actual<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> suffixLength <span class="token operator">&lt;=</span> prefixLength <span class="token operator">||</span>
       expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> suffixLength <span class="token operator">&lt;=</span> prefixLength<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">findCommonPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     prefixLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> end <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> actual<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> prefixLength <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> prefixLength<span class="token operator">++</span><span class="token punctuation">)</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>prefixLength<span class="token punctuation">)</span> <span class="token operator">!=</span> actual<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>prefixLength<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 
   <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">compact</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">startingEllipsis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">startingContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>DELTA_START<span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">delta</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>DELTA_END<span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">endingContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">endingEllipsis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">startingEllipsis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> prefixLength <span class="token operator">&gt;</span> contextLength <span class="token operator">?</span> ELLIPSIS <span class="token operator">:</span> “”<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">startingContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">int</span> contextStart <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> prefixLength <span class="token operator">-</span> contextLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> contextEnd <span class="token operator">=</span> prefixLength<span class="token punctuation">;</span>
     <span class="token keyword">return</span> expected<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>contextStart<span class="token punctuation">,</span> contextEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">delta</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">int</span> deltaStart <span class="token operator">=</span> prefixLength<span class="token punctuation">;</span>
     <span class="token keyword">int</span> deltaEnd <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> suffixLength<span class="token punctuation">;</span>
     <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>deltaStart<span class="token punctuation">,</span> deltaEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">endingContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">int</span> contextStart <span class="token operator">=</span> expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> suffixLength<span class="token punctuation">;</span>
     <span class="token keyword">int</span> contextEnd <span class="token operator">=</span>
       <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>contextStart <span class="token operator">+</span> contextLength<span class="token punctuation">,</span> expected<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> expected<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>contextStart<span class="token punctuation">,</span> contextEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">endingEllipsis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token punctuation">(</span>suffixLength <span class="token operator">&gt;</span> contextLength <span class="token operator">?</span> ELLIPSIS <span class="token operator">:</span> “”<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>This is actually quite pretty. The module is separated into a group of analysis functions and another group of synthesis functions. They are topologically sorted so that the definition of each function appears just after it is used. All the analysis functions appear first, and all the synthesis functions appear last.</p> <p>If you look carefully, you will notice that I reversed several of the decisions I made earlier in this chapter. For example, I inlined some extracted methods back into formatCompactedComparison, and I changed the sense of the shouldNotBeCompacted expression. This is typical. Often one refactoring leads to another that leads to the undoing of the first. Refactoring is an iterative process full of trial and error, inevitably converging on something that we feel is worthy of a professional.</p> <p>CONCLUSION
And so we have satisfied the Boy Scout Rule. We have left this module a bit cleaner than we found it. Not that it wasn’t clean already. The authors had done an excellent job with it. But no module is immune from improvement, and each of us has the responsibility to leave the code a little better than we found it.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iszhaoxg/cleancode-book/edit/main/docs/ch15.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/28/2021, 5:45:39 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/cleancode-book/ch14.html" class="prev">
        第 14 章 Successive Refinement
      </a></span> <span class="next"><a href="/cleancode-book/ch16.html">
        第 16 章 Refactoring SerialDate
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/cleancode-book/assets/js/app.641b54bb.js" defer></script><script src="/cleancode-book/assets/js/2.1ffb1fd2.js" defer></script><script src="/cleancode-book/assets/js/15.80e3ee62.js" defer></script>
  </body>
</html>
